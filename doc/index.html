<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>CouchDB</title>
<meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="_priv/uikit.css" title="EDoc"></head>
<div class="wrapper"><a class="menu-button" href="#" uk-icon="icon: menu;ratio:1.1"></a><aside class="uk-light"><a class="menu-button" style="float:right" href="#" uk-icon="icon: close"></a><div class="main-logo"><h1>CouchDB</h1><span class="version">2.0.0-alpha2</span></div><ul class="uk-nav uk-nav-default"><li class="uk-nav-header">Pages</li><li class=""><a href="index.html">Index</a></li><li class="uk-nav-header">Modules</li><li><a href="couchdb.html" class="module">couchdb</a></li><li><a href="couchdb_app.html" class="module">couchdb_app</a></li><li><a href="couchdb_attachments.html" class="module">couchdb_attachments</a></li><li><a href="couchdb_common_urls.html" class="module">couchdb_common_urls</a></li><li><a href="couchdb_databases.html" class="module">couchdb_databases</a></li><li><a href="couchdb_design_documents.html" class="module">couchdb_design_documents</a></li><li><a href="couchdb_documents.html" class="module">couchdb_documents</a></li><li><a href="couchdb_server.html" class="module">couchdb_server</a></li></ul>
<a href="http://www.erlang.org/"><img src="_priv/erlang.svg" align="right" border="0" alt="erlang logo"></a>
</aside><main class="uk-padding-left"><h1>CouchDB</h1>


<p><a href="https://hex.pm/packages/couchdb"><img src="https://img.shields.io/hexpm/v/couchdb.svg?style=flat-square&labelColor=5c676d&color=714a94" alt="Hex pm" title="" /></a>
<a href="https://secure.travis-ci.org/eyedouble/couchdb"><img src="https://secure.travis-ci.org/eyedouble/couchdb.svg?branch=master
" alt="Build Status" title="Build Status" /></a>
<a href="LICENSE"><img src="https://img.shields.io/github/license/eyedouble/couchdb?color=007ec6&style=flat-square" alt="License" title="" /></a></p>

<p><strong>Erlang / Elixir library for <a href="http://couchdb.apache.org">Apache CouchDB</a> or <a href="https://cloudant.com">IBM Cloudant</a>. CouchDB provides you a full featured and easy-to-use client to access and manage multiple nodes.</strong></p>

<ul>
<li><a href="https://hex.pm/packages/couchdb">Install from hex.pm</a></li>
<li><a href="https://hexdocs.pm/couchdb">Documentation available on hexdoc</a>
<p>A Hex.pm is available but as long as the version contains an appendix do not consider it stable.</p><p>**THIS IS WORK-IN-PROGRESS FOR NOW (September 2019)**</p></li>
</ul>
<p><strong>Version:</strong> 2.0.0-alpha2</p>

<h2>Contribute</h2>


<p>For issues, comments or feedback please <a href="http://github.com/eyedouble/couchdb/issues">create an
issue</a>.</p>

<h2>Notes</h2>

<h3>Forked from Couchbeam</h3>

<p><strong>CouchDB</strong> is a a fork of <a href="http://github.com/benoitc/couchbeam. Backwards incompatible API changes have been introduced as well as a complete new structure. Therefore the decision was made to release this version under a new name: **CouchDB**."><code>couchbeam</code></a></p>

<h3>Semantic versioning</h3>

<p>To comply with <a href="https://semver.org/">Semantic Versioning</a> the version number has been bumped to <code>2.0.0</code>.</p>

<hr />
<h1>Original README:</h1>


<h1>Couchbeam - simple Barrel and Apache CouchDB client library for Erlang applications</h1>


<h1>couchbeam</h1>


<p>Couchbeam is a simple erlang library for <a href="https://barrel-db.org">Barrel</a> or <a href="http://couchdb.apache.org">Apache CouchDB</a>. Couchbeam provides you a full featured and easy client to access and manage multiple nodes.</p>

<h4>Main features:</h4>


<ul>
<li>Complete support of the BarrelDB and Apache CouchDB API</li>
<li>Stream view results to your app</li>
<li>Stream changes feeds</li>
<li>reduced memory usage</li>
<li>fetch and send attachments in a streaming fashion</li>
<li>by default use the JSX module to encode/decode JSON</li>
<li><p>support <a href="http://github.com/davisp/jiffy">Jiffy</a> a JSON encoder/decoder</p>in C.
</li>
</ul>
<h4>Useful modules are:</h4>


<ul>
<li><a href="http://github.com/benoitc/couchbeam/blob/master/doc/couchbeam.md"><code>couchbeam</code></a>: The <code>couchbeam</code> module is the main interface for interaction with this application. It includes functions for managing connections to Apache CouchDB or RCOUCH servers and databases and for performing document creations, updates, deletes, views...</li>
<li><a href="http://github.com/benoitc/couchbeam/blob/master/doc/couchbeam_doc.md"><code>couchbeam_doc</code></a> Module to manipulate Documents structures. You can set values,
updates keys, ...
</li>
<li><a href="http://github.com/benoitc/couchbeam/blob/master/doc/couchbeam_attachments.md"><code>couchbeam_attachments</code></a>: Module to manipulate attachments. You can add, remove
attachments in a Document structure (inline attachments).
</li>
<li><a href="http://github.com/benoitc/couchbeam/blob/master/doc/couchbeam_view.md"><code>couchbeam_view</code></a>: Module to manage view results.</li>
<li><a href="http://github.com/benoitc/couchbeam/blob/master/doc/couchbeam_changes.md"><code>couchbeam_changes</code></a>: Module to manage changes feeds. Follow continuously
the changes in a db or get all changes at once.
</li>
</ul>
<p>The goal of Couchbeam is to ease the access to the Apache CouchDB and RCOUCH HTTP API in erlang.</p>

<p>Read the <a href="https://raw.github.com/benoitc/couchbeam/master/NEWS">NEWS</a> file
to get last changelog.</p>

<h2>Installation</h2>


<p>Download the sources from our <a href="http://github.com/benoitc/couchbeam">Github repository</a></p>

<p>To build the application simply run 'make'. This should build .beam, .app
files and documentation.</p>

<p>To run tests run 'make test'.
To generate doc, run 'make doc'.</p>

<p>Or add it to your rebar config</p>

<p><pre>```
   erlang
{deps, [</pre></p>
<pre><code>....
{couchbeam, ".*", {git, "git://github.com/benoitc/couchbeam.git", {branch, "master"}}}
</code></pre>

<p>]}.
<pre>```</pre></p>

<p>Note to compile with jiffy you need to define in the erlang options the
variable <code>WITH_JIFFY</code>.</p>

<p>if you use rebar, add to your <code>rebar.config</code>:</p>

<p><pre><code>`
   erlang
{erl<em>opts, [{d, 'WITH</em>JIFFY'}]}.
</code></pre>`</p>

<p>or use the <code>rebar</code> command with the <code>-D</code> options:</p>

<p><pre><code>`
   sh
rebar compile -DWITH_JIFFY
</code></pre>`</p>

<h2>Basic Usage</h2>


<h3>Start couchbeam</h3>


<p>Couchbeam is an <a href="http://www.erlang.org/doc/design_principles/users_guide.html">OTP</a>
application. You have to start it first before using any of the
functions. The couchbeam application will start the default socket pool
for you.</p>

<p>To start in the console run:</p>

<p><pre><code>`
   sh
$ erl -pa ebin
1> couchbeam:start().
ok
</code></pre>`</p>

<p>It will start hackney and all of the application it depends on:</p>

<p><pre><code>`
   erlang
application:start(crypto),
application:start(asn1),
application:start(public_key),
application:start(ssl),
application:start(hackney),
application:start(couchbeam).
</code></pre>`</p>

<p>Or add couchbeam to the applications property of your .app in a release</p>

<h3>Create a connection to the server</h3>


<p>To create a connection to a server machine:</p>

<p><pre><code>`
   erlang
Url = "http://localhost:5984",
Options = [],
S = couchbeam:server_connection(Url, Options).
</code></pre>`</p>

<p>Test the connection with <code>couchbeam:server_info/1</code> :</p>

<p><pre><code>`
   erlang
{ok, <em>Version} = couchbeam:server</em>info(S).
</code></pre>`</p>

<h3>Open or Create a database</h3>


<p>All document operations are done in databases. To open a database simply do:</p>

<p><pre><code>`
   erlang
Options = [],
{ok, Db} = couchbeam:open_db(Server, "testdb", Options).
</code></pre>`</p>

<p>To create a new one:</p>

<p><pre><code>`
   erlang
Options = [],
{ok, Db} = couchbeam:create_db(Server, "testdb", Options).
</code></pre>`</p>

<p>You can also use the shorcut <code>couchbeam:open<em>or</em>create_db/3</code>. that
will create a database if it does not exist.</p>

<h3>Make a new document</h3>


<p>Make a new document:</p>

<p><pre><code>`
   erlang
Doc = {[
{&lt;&lt;"_id">>, &lt;&lt;"test">>},
{&lt;&lt;"content">>, &lt;&lt;"some text">>}
]}.
</code></pre>`</p>

<p>And save it to the database:</p>

<p><pre><code>`
   erlang
{ok, Doc1} = couchbeam:save_doc(Db, Doc).
</code></pre>`</p>

<p>The <code>couchbeam:save_doc/2</code> return a new document with updated
revision and if you do not specify the _id, a unique document id.</p>

<p>To change an document property use functions from <code>couchbeam_doc</code>.</p>

<h3>Retrieve a document</h3>


<p>To retrieve a document do:</p>

<p><pre><code>`
   erlang
{ok, Doc2} = couchbeam:open_doc(Db, "test").
</code></pre>`</p>

<p>If you want a specific revision:</p>

<p><pre><code>`
   erlang
Rev = couchbeam<em>doc:get</em>rev(Doc1),
Options = [{rev, Rev}],
{ok, Doc3} = couchbeam:open_doc(Db, "test", Options).
</code></pre>`</p>

<p>Here we get the revision from the document we previously stored. Any
options from the Apache CouchDB and RCOUCH API can be used.</p>

<h3>Get all documents</h3>


<p>To get all documents you have first to create an object
that will keep all informations.</p>

<p><pre><code>`
   erlang
Options = [include<em>docs],
{ok, AllDocs} = couchbeam</em>view:all(Db, Options).
</code></pre>`</p>

<p>Ex of results:</p>

<p><pre>```
   erlang
{ok,[{[{&lt;&lt;"id">>,&lt;&lt;"7a0ce91d0d0c5e5b51e904d1ee3266a3">>},</pre></p>
<pre><code>      {&lt;&lt;"key"&gt;&gt;,&lt;&lt;"7a0ce91d0d0c5e5b51e904d1ee3266a3"&gt;&gt;},
      {&lt;&lt;"value"&gt;&gt;,
       {[{&lt;&lt;"rev"&gt;&gt;,&lt;&lt;"15-15c0b3c4efa74f9a80d28ac040f18bdb"&gt;&gt;}]}},
      {&lt;&lt;"doc"&gt;&gt;,
       {[{&lt;&lt;"_id"&gt;&gt;,&lt;&lt;"7a0ce91d0d0c5e5b51e904d1ee3266a3"&gt;&gt;},
         {&lt;&lt;"_rev"&gt;&gt;,&lt;&lt;"15-15c0b3c4efa74f9a80d28ac040f18"...&gt;&gt;}]}}]},
    ]}.
</code></pre>

<p><pre>```</pre></p>

<p>All functions to manipulate these results are in the <code>couchbeam_view</code> module.</p>

<h3>Couch DB views</h3>


<p>Views are workin like all_docs. You have to create a View object before
doing anything.</p>

<p><pre><code>`
   erlang
Options = [],
DesignName = "designname",
ViewName = "viewname",
{ok, ViewResults} = couchbeam_view:fetch(Db, {DesignName, ViewName}, Options).
</code></pre>`</p>

<p>Like the <code>all_docs</code> function, use the functions
from <code>couchbeam_view</code> module to manipulate results. You can pass
any querying options from the <a href="http://docs.rcouch.org/en/latest/api/ddoc/views.html">view API</a>.</p>

<p>Design doc are created like any documents:</p>

<p><pre>```
   erlang
DesignDoc = {[</pre></p>
<pre><code>    {&lt;&lt;"_id"&gt;&gt;, &lt;&lt;"_design/couchbeam"&gt;&gt;},
    {&lt;&lt;"language"&gt;&gt;,&lt;&lt;"javascript"&gt;&gt;},
    {&lt;&lt;"views"&gt;&gt;,
        {[{&lt;&lt;"test"&gt;&gt;,
            {[{&lt;&lt;"map"&gt;&gt;,
                &lt;&lt;"function (doc) {\n if (doc.type == \"test\") {\n emit(doc._id, doc);\n}\n}"&gt;&gt;
            }]}
        },{&lt;&lt;"test2"&gt;&gt;,
            {[{&lt;&lt;"map"&gt;&gt;,
                &lt;&lt;"function (doc) {\n if (doc.type == \"test2\") {\n emit(doc._id, null);\n}\n}"&gt;&gt;
            }]}
        }]}
    }
]},
</code></pre>

<p>{ok, DesignDoc1} = couchbeam:save_doc(Db, DesignDoc).
<pre>```</pre></p>

<p>You can also use <a href="http://github.com/couchapp/couchapp">couchapp</a> to manage them
more easily.</p>

<h3>Stream View results</h3>


<p>While you can get results using <code>couchbeam_views:fetch/2</code>, you can also retrieve
all rows in a streaming fashion:</p>

<p><pre>```
   erlang
ViewFun = fun(Ref, F) -></pre></p>
<pre><code>receive
    {Ref, done} -&gt;
        io:format("done", []),
        done;
    {Ref, {row, Row}} -&gt;
        io:format("got ~p~n", [Row]),
        F(Ref, F);
    {error, Ref, Error} -&gt;
        io:format("error: ~p~n", [Error])
end
</code></pre>

<p>end,</p>

<p>{ok, StreamRef} = couchbeam<em>view:stream(Db, 'all</em>docs'),
ViewFun(StreamRef, ViewFun),
{ok, StreamRef2} = couchbeam<em>view:stream(Db, 'all</em>docs', [include_docs]),
ViewFun(StreamRef2, ViewFun).
<pre>```</pre></p>

<p>You can of course do the same with a view:</p>

<p><pre><code>`
   erlang
DesignNam = "designname",
ViewName = "viewname",
{ok, StreamRef3} = couchbeam<em>view:stream(Db, {DesignNam, ViewName}, [include</em>docs]),
ViewFun(StreamRef3, ViewFun).
</code></pre>`</p>

<h3>Put, Fetch and Delete documents attachments</h3>


<p>You can add attachments to any documents. Attachments could be anything.</p>

<p>To send an attachment:</p>

<p><pre><code>`
   erlang
DocID = "test",
AttName = "test.txt",
Att = "some content I want to attach",
Options = []
{ok, <em>Result} = couchbeam:put</em>attachment(Db, DocId, AttName, Att, Options).
</code></pre>`</p>

<p>All attachments are streamed to servers. <code>Att</code> could be also be an iolist
or functions, see <code>couchbeam:put_attachment/5</code> for more information.</p>

<p>To fetch an attachment:</p>

<p><pre><code>`
   erlang
{ok Att1} = couchbeam:fetch_attachment(Db, DocId, AttName).
</code></pre>`</p>

<p>You can use <code>couchbeam:stream<em>fetch</em>attachment/6</code> for the stream
fetch.</p>

<p>To delete an attachment:</p>

<p><pre><code>`
   erlang
{ok, Doc4} = couchbeam:open<em>doc(Db, DocID),
ok = couchbeam:delete</em>attachment(Db, Doc4, AttName).
</code></pre>`</p>

<h3>Changes</h3>


<p>Apache CouchDB and RCOUCH provide a means to get a list of changes made to documents in
the database. With couchbeam you can get changes using <code>couchbeam<em>changes:follow</em>once/2</code>.
This function returns all changes immediately. But you can also retrieve
all changes rows using longpolling :</p>

<p><pre><code>`
   erlang
Options = [],
{ok, LastSeq, Rows} = couchbeam<em>changes:follow</em>once(Db, Options).
</code></pre>`</p>

<p>Options can be any Changes query parameters. See the <a href="http://docs.rcouch.org/en/latest/api/database/changes.html">change API</a> for more informations.</p>

<p>You can also get <a href="http://docs.rcouch.org/en/latest/api/database/changes.html#continuous">continuous</a>:</p>

<p><pre>```
   erlang
ChangesFun = fun(StreamRef, F) -></pre></p>
<pre><code>receive
    {StreamRef, {done, LastSeq}} -&gt;
        io:format("stopped, last seq is ~p~n", [LastSeq]),
        ok;
    {StreamRef, {change, Change}} -&gt;
        io:format("change row ~p ~n", [Change]),
        F(StreamRef, F);
    {StreamRef, Error}-&gt;
        io:format("error ? ~p ~n,", [Error])
end
</code></pre>

<p>end,
Options = [continuous, heartbeat],
{ok, StreamRef} = couchbeam_changes:follow(Db, Options),
ChangesFun(StreamRef, ChangesFun).
<pre>```</pre></p>


<blockquote>
  <p><strong>Note</strong>: a <code>gen_changes</code> behaviour exists in couchbeam that you can
  use to create your own specific gen_server receiving changes. Have a
  look in the
  <a href="https://github.com/benoitc/couchbeam/blob/master/examples/test_gen_changes.erl">example</a>
  for more info.
</p>
</blockquote>
<h3>Authentication/ Connections options</h3>


<p>You can authenticate to the database or Apache CouchDB or RCOUCH server by filling
options to the Option list in <code>couchbeam:server_connection/4</code> for the
server or in <code>couchbeam:create_db/3</code>, <code>couchbeam:open_db/3</code>,
<code>couchbeam:wopen<em>or</em>create_db/3</code> functions.</p>

<p>To set basic_auth on a server:</p>

<p><pre><code>`
   erlang
UserName = "guest",
Password = "test",
Url = "http://localhost:5984",
Options = [{basic<em>auth, {UserName, Password}}],
S1 = couchbeam:server</em>connection(Url, Options).
</code></pre>`</p>

<p>Couchbeam support SSL, OAuth, Basic Authentication, and Proxy. You can
also set a cookie. For more informations about the options have a look
in the <code>couchbeam:server_connection/2</code> documentation.</p></main><script src="_priv/uikit.min.js"></script></div>
</html>